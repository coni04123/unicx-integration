trigger:
  branches:
    include:
      - develop

variables:
  imageName: unicx-integration
  acrName: unicxacr
  tag: '$(Build.BuildId)'

stages:
  - stage: BuildAndPush
    displayName: Build and Push Docker image
    jobs:
      - job: DockerBuild
        displayName: Build and Push to ACR
        pool:
          vmImage: ubuntu-latest
        steps:
          - checkout: self
            displayName: Checkout code
          
          - task: AzureCLI@2
            displayName: Build and Push Docker image to ACR
            inputs:
              azureSubscription: '2N5 GLOBAL'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                set -e  # Exit on error
                
                # Login to Azure Container Registry
                echo "Logging into Azure Container Registry..."
                az acr login --name $(acrName)
                
                # Navigate to the directory containing the Dockerfile
                # The pipeline file is in unicx-integration/, so we need to be in that directory
                if [ -d "unicx-integration" ]; then
                  cd unicx-integration
                fi
                
                # Verify Dockerfile exists
                if [ ! -f "Dockerfile" ]; then
                  echo "Error: Dockerfile not found in current directory: $(pwd)"
                  ls -la
                  exit 1
                fi
                
                echo "Building Docker image..."
                # Build Docker image with both tags
                docker build -f Dockerfile -t $(acrName).azurecr.io/$(imageName):$(tag) -t $(acrName).azurecr.io/$(imageName):latest .
                
                echo "Pushing Docker images..."
                # Push both tags
                docker push $(acrName).azurecr.io/$(imageName):$(tag)
                docker push $(acrName).azurecr.io/$(imageName):latest
                
                echo "Build and push completed successfully!"

  - stage: DeployToAKS
    displayName: Deploy using Helm
    dependsOn: BuildAndPush
    condition: succeeded()
    jobs:
      - deployment: Deploy
        displayName: Helm Upgrade/Install
        environment: 'aks-prod'
        pool:
          vmImage: ubuntu-latest
        strategy:
          runOnce:
            deploy:
              steps:
                - task: HelmInstaller@1
                  inputs:
                    helmVersionToInstall: 'latest'

                - task: HelmDeploy@0
                  displayName: Helm upgrade
                  inputs:
                    connectionType: 'Azure Resource Manager'
                    azureSubscription: '2N5 GLOBAL'
                    azureResourceGroup: 'unicx-dev'
                    kubernetesCluster: 'unicxdev-aks-kubernetes'
                    command: 'upgrade'
                    chartType: 'FilePath'
                    chartPath: 'deployment/integration-chart'
                    releaseName: 'unicx'
                    valueFile: 'deployment/integration-chart/values.yaml'
                    overrideValues: |
                      image.repository=$(acrName).azurecr.io/$(imageName)
                      image.tag=$(tag)
                      replicaCount=2
                    install: true
